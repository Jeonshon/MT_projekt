<!DOCTYPE html>
<html lang="en">
<head>
    <title>DRŽAVNI PRORAČUN</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport" charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="scripts/d3.min.js"></script>

    <script>

    function onPageLoad(){
      var resp = {
        "aggs": {
          "skupniZnesek": {
            "sum": {
              "field": "Znesek"
            }
          }
        },
        "size": 0,
        "_source": {
          "excludes": []
        },
        "stored_fields": [
          "*"
        ],
        "script_fields": {},
        "docvalue_fields": [],
        "query": {
          "bool": {
            "must": [],
            "filter": [
              {
                "match_all": {}
              }
            ],
            "should": [],
            "must_not": []
          }
        }
      }
      $.ajax({
          method: "POST",
          url: "http://localhost:9200/posebni/_search?pretty=true",
          crossDomain: true,  
          async: true,
          data: JSON.stringify(resp),
          dataType : 'json',
          contentType: 'application/json',
      })
      .done(function( resp ) {
        console.log(resp.aggregations.skupniZnesek.value);
        document.getElementById("jumboZnesek").innerHTML = Math.round(resp.aggregations.skupniZnesek.value) + " €";
        //console.log(resp)
      });

      var resp = {
        "aggs": {
          "leta": {
            "histogram": {
              "field": "Leto",
              "interval": 1,
              "min_doc_count": 1
            },
            "aggs": {
              "znesekSum": {
                "sum": {
                  "field": "Znesek"
                }
              }
            }
          }
        },
          "size": 0,
          "_source": {
            "excludes": []
          },
          "stored_fields": [
            "*"
          ],
          "script_fields": {},
          "docvalue_fields": [],
          "query": {
            "bool": {
              "must": [],
              "filter": [
                {
                  "match_all": {}
                }
              ],
              "should": [],
              "must_not": []
            }
          }
      }
      $.ajax({
          method: "POST",
          url: "http://localhost:9200/posebni/_search?pretty=true",
          crossDomain: true,  
          async: true,
          data: JSON.stringify(resp),
          dataType : 'json',
          contentType: 'application/json',
      })
      .done(function( resp ) {
        console.log("KOKOKOKOKOKO")
        console.log(resp)
        console.log("KOKOKOKOKOKO")

        // D3 code goes here.
        var sample = resp.aggregations.leta.buckets;
        // d3 donut chart
        var width = 600,
            height = 500,
            radius = Math.min(width, height) / 2;
        //var color = ['#ff7f0e', '#d62728', '#2ca02c', '#1f77b4'];
        var color =["#b3e2cd","#fdcdac","#cbd5e8","#f4cae4","#e6f5c9","#fff2ae","#f1e2cc","#cccccc"]

        var arc = d3.arc()
            .innerRadius(radius * 0.37)         // This is the size of the donut hole
            .outerRadius(radius * 0.6)
        var outerArc = d3.arc()
            .innerRadius(radius * 0.7)
            .outerRadius(radius * 0.7)
        var pie = d3.pie()
            .sort(null)
            .value(function (d) { return d.znesekSum.value; });
            
            // .onClickSegment(function(a) {
            //     alert("Segment clicked! See the console for all data passed to the click handler.");
            //     console.log(a);
            //   });
        //var svg = d3.select("#container2").append("svg")
            var svg = d3.select("div#container")
              .append("svg")
              .attr("preserveAspectRatio", "xMinYMin meet")
              .attr("viewBox", "-300 -180 580 580")
              .classed("svg-content", true);
        // var g = svg.selectAll(".arc")
        //     .data(pie(sample))
        //     .enter()
        //     .append("g")
        //     .attr("class", "arc");
        // g.append("path")
        //     .attr("d", arc)
        //     .style("fill", function (d, i) { return color[i]; });
        // g.append("text")
        //     .attr("transform", function (d) { return "translate(" + arc.centroid(d) + ")"; })
        //     .attr("dy", ".35em")
        //     .style("text-anchor", "middle")
        //     .style("fill", "white")
        //     .text(function (d) { return d.key; });

        
          
        svg
            .selectAll('.allSlices')
            .data(pie(sample))
            .enter()
            .append('path')
            .attr('d', arc)
            .attr('fill', function(d, i){ console.log(d.data.key); return color[i] })
            .attr("stroke", "white")
            .style("stroke-width", "2px")
            .style("opacity", 0.7)
            .on("click", function(d){
                  console.log(d.data.key);
                  d3.select(this)
                    .style("fill", "#4D4B4B");

                  LetoHistogram(d.data.key)
                  return d;
            })
            .on("mouseover", function() {
              d3.select(this)
                .style("fill", "#4D4B4B");
            })
            .on("mouseout", function() {
              d3.select(this)
              .style("fill", function(d) {
                        console.log(d);
                        return d.color;
                    });
            });

            

        svg
            .selectAll('.allPolylines')
            .data(pie(sample))
            .enter()
            .append('polyline')
              .attr("stroke", "black")
              .style("fill", "none")
              .attr("stroke-width", 1)
              .attr('points', function(d) {
                var posA = arc.centroid(d) // line insertion in the slice
                var posB = outerArc.centroid(d)  // line break: we use the other arc generator that has been built only for that
                var posC = outerArc.centroid(d); // Label position = almost the same as posB
                var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2 // we need the angle to see if the X position will be at the extreme right or extreme left
                posC[0] = radius * 0.95 * (midangle < Math.PI ? 1 : -1); // multiply by 1 or -1 to put it on the right or on the left
                return [posA, posB, posC]
              })

          // Add the polylines between chart and labels:
        svg
            .selectAll('.allLabels')
            .data(pie(sample))
            .enter()
            .append('text')
              .text( function(d) { console.log(d.data.key) ; return d.data.key } )
              .attr('transform', function(d) {
                  var pos = outerArc.centroid(d);
                  var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2
                  pos[0] = radius * 0.99 * (midangle < Math.PI ? 1 : -1);
                  return 'translate(' + pos + ')';
              })
              .style('text-anchor', function(d) {
                  var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2
                  return (midangle < Math.PI ? 'start' : 'end')
              })
              .attr('class', 'title1')
        });
    }





    function LetoHistogram(leto1234){
      var resp = {
        "aggs": {
          "kategorije": {
            "terms": {
              "field": "POL_NAME.keyword",
              "order": {
                "val": "desc"
              },
              "size": 40
            },
            "aggs": {
              "val": {
                "sum": {
                  "field": "Znesek"
                }
              }
            }
          }
        },
        "size": 0,
        "_source": {
          "excludes": []
        },
        "stored_fields": [
          "*"
        ],
        "script_fields": {},
        "docvalue_fields": [],
        "query": {
          "bool": {
            "must": [],
            "filter": [
              {
                "match_all": {}
              },
              {
                "match_phrase": {
                  "Leto": {
                    "query": leto1234
                  }
                }
              }
            ],
            "should": [],
            "must_not": []
          }
        }
      }
      $.ajax({
          method: "POST",
          url: "http://localhost:9200/posebni/_search?pretty=true",
          crossDomain: true,  
          async: true,
          data: JSON.stringify(resp),
          dataType : 'json',
          contentType: 'application/json',
      })
      .done(function( resp ) {

        //console.log(resp);
        //console.log(resp.aggregations.kategorije.buckets);

        var sample = resp.aggregations.kategorije.buckets
        console.log(sample)
        // d3.selectAll("#svg2 > *").remove(); 
        d3.selectAll("#container2 > *").remove(); 
        //const svg = d3.select("#container").append("svg")
        //const svgContainer = d3.select('#container').append("svg");



        const margin = 120;
        const width = 400;//document.getElementById('colsvg2').offsetWidth - 2 * margin;
        const height = 400;//document.getElementById('colsvg2').offsetHeight - 2 * margin;
        
        // const svg = d3.select("#svg2")
        //   .attr("width", width + margin)
        //   .attr("height", height + margin/2);
        var svg = d3.select("div#container2")
            .append("svg")
            .attr("preserveAspectRatio", "xMinYMin meet")
            .attr("viewBox", "0 0 580 520")
            .classed("svg-content", true);

        const chart = svg.append('g')
          .attr('transform', `translate(${margin}, 100)`);

        const xScale = d3.scaleBand()
        .range([0, 400])
        .domain(sample.map((s) => s.key))
        .padding(0.4);

        const yScale = d3.scaleLinear()
        .range([400, 0])
        .domain([0, sample[0].val.value]);

        // vertical grid lines
        // const makeXLines = () => d3.axisBottom()
        //   .scale(xScale)

        const makeYLines = () => d3.axisLeft()
        .scale(yScale)


        chart.append('g')
        .call(d3.axisLeft(yScale));

        chart.append('g')
        .attr('class', 'grid')
        .call(makeYLines()
        .tickSize(-width, 0, 0)
        .tickFormat('')
        )

        const barGroups = chart.selectAll()
        .data(sample)
        .enter()
        .append('g')

        barGroups.append('rect')
        .attr('class', 'bar')
        .attr('x', (g) => xScale(g.key))
        .attr('y', (g) => yScale(g.val.value))
        .attr('height', (g) => height - yScale(g.val.value))
        .attr('width', xScale.bandwidth())

        .on('mouseenter', function (actual, i) {
            d3.selectAll('.val.value')
            .attr('opacity', 0)


            d3.select(this)
            .transition()
            .duration(00)
            .attr('opacity', 0.6)
            .attr('x', (a) => xScale(a.key) - 5)
            .attr('width', xScale.bandwidth() + 10)

            const y = yScale(actual.val.value)

            chart.append('line')
            .attr('id', 'limit')
            .attr('x1', 0)
            .attr('y1', y)
            .attr('x2', width)
            .attr('y2', y)

            chart.append("text")
            .attr('x', 0)
            .attr('y', yScale(actual.val.value) - 10)
            .attr('class', 'textLimit')
            .attr('id', 'limit')
            .text(`${actual.key}` + ":  " + `${actual.val.value}€`)

        })

        .on('mouseleave', function () {
            d3.selectAll('.val.value')
            .attr('opacity', 1)

            d3.select(this)
            .transition()
            .duration(250)
            .attr('opacity', 1)
            .attr('x', (a) => xScale(a.key))
            .attr('width', xScale.bandwidth())

            chart.selectAll('#limit').remove()
            chart.selectAll('.divergence').remove()
        })
 

        svg.append('text')
        .attr('class', 'text')
        .attr('x', -(height / 2) - margin)
        .attr('y', margin / 11)
        .attr('transform', 'rotate(-90)')
        .attr('text-anchor', 'middle')
        .text('Znesek')


        svg.append("text")
        .attr("transform", "translate(" + (width/2) + "," + (height/2 + 400) + ")")
        .text("Sektorji");

        svg.append('text')
        .attr('class', 'title')
        .attr('x', width / 2 + margin)
        .attr('y', 40)
        .attr('text-anchor', 'middle')
        .text('DRŽAVNI PRORAČUN ZA IZBRANO LETO');

        //$("#svg2").slideDown("slow");
        svg.transition()
          .duration(1050)
          .attr('x', 10)
          .attr('y', 20); 

      })
      .fail(function( resp ) {
          console.log(resp);
      });
    }

    </script>

    <style>

        #slider6 {
          position: relative;
          font-family: Verdana,Arial,sans-serif;
          font-size: 1.1em;
          border: 1px solid #aaaaaa;
          z-index: 2;
          height: .8em;
          margin: 35px 0;
        }
        body {
          font-family: "Inter UI", -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";;
          background-color: #d8d8d8;
        }
        
        .btn {
        /* background-color: #9FAAAE; */
        cursor:pointer;
        border: none;
        padding: 15px 35px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        }

        div#layout {
          text-align: center;
        }
        
        /* div#container {
          width: 100%;
          height: 800px;
          margin: auto;
          margin-top: 10px;
          
          /* background-color: #2F4A6D; */
        } */

        .textLimit {
          font-family: "Inter UI", -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
          font-weight: 600;
          font-size: 16px;
        }
        
        /* svg {
          display: block;
          margin: auto;
          width: 1300px;
          height: 700px;
        } */

        /* #svg1 {
          display: block;
          margin: auto;
          float: left;
        }
        #svg2 {
          display: block;
          margin: auto;
          width: 800px;
          height: 700px;
          float: left;
        } */
        
        .bar {
          fill: #006e63;
        }
        
        text {
          font-size: 14px;
          /* fill: #fff; */
        }
        
        path {
          stroke: gray;
        }
        
        line {
          stroke: gray;
        }
        
        line#limit {
          stroke: #000000;
          stroke-width: 1.5;
          stroke-dasharray: 8 2;
        }
        
        .grid path {
          stroke-width: 0;
        }
        
        .grid .tick line {
          stroke: #9FAAAE;
          stroke-opacity: 0.3;
        }
        
        text.divergence {
          font-size: 14px;
          fill: #2F4A6D;
        }
        
        text.value {
          font-size: 14px;
        }
        
        .title1 {
          font-size: 16px;
          font-weight: 600;
          font-family: "Inter UI", -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        text.title {
          font-size: 19px;
          font-weight: 600;
        }
        
        text.label {
          font-size: 14px;
          font-weight: 400;
        }
        
        text.source {
          font-size: 10px;
        }

        .svg-container {
            display: inline-block;
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            vertical-align: top;
            overflow: hidden;
        }
        .svg-content {
            display: inline-block;
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>

  <div class="jumbotron" style="text-align: center; background-color: #cccccc;">
    <h1>Skupni znesek porabljenega državnega proračuna od leta 2015</h1>
    <h1 id="jumboZnesek" style="font-size: 40pt; font-weight: bold;"></h1>
  </div>

  <body style="text-align: center;" onload="onPageLoad()">
    IZBERITE LETO
    <br>

  <!-- <div id="slider6" class="d3-slider d3-slider-horizontal"><a class="d3-slider-handle" xlink:href="#" style="left: 60%;"></a><svg class="d3-slider-axis d3-slider-axis-bottom" width="898" height="50" style="left: -50px;"><g transform="translate(50,0)"><g class="tick" transform="translate(0,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: middle;">2000</text></g><g class="tick" transform="translate(79.80000000000001,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: middle;">2010</text></g><g class="tick" transform="translate(159.60000000000002,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: middle;">2020</text></g><g class="tick" transform="translate(239.39999999999998,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: middle;">2030</text></g><g class="tick" transform="translate(319.20000000000005,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: middle;">2040</text></g><g class="tick" transform="translate(399,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: middle;">2050</text></g><g class="tick" transform="translate(478.79999999999995,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: middle;">2060</text></g><g class="tick" transform="translate(558.5999999999999,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: middle;">2070</text></g><g class="tick" transform="translate(638.4000000000001,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: middle;">2080</text></g><g class="tick" transform="translate(718.2,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: middle;">2090</text></g><g class="tick" transform="translate(798,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: middle;">2100</text></g><path class="domain" d="M0,6V0H798V6"></path></g></svg></div> -->
  <!-- <button class="btn" onclick="LetoHistogram(2015)">2015</button>
  <button class="btn" onclick="LetoHistogram(2016)">2016</button>
  <button class="btn" onclick="LetoHistogram(2017)">2017</button>
  <button class="btn" onclick="LetoHistogram(2018)">2018</button>
  <button class="btn" onclick="LetoHistogram(2019)">2019</button> -->
  <!-- <div id="container2" style="width: 100%;"></div>
  <div id="container" style="margin-bottom: 150px;"></div> -->

  <div class="row" style="margin-bottom: 150px; height: 700px">
    <div class="col-5" id="colsvg1">
    <div id="container" class="svg-container">
      <!-- <svg id="svg1" ></svg> -->
    </div>
      
    </div>
    <div class="col-7" id="colsvg2">
      <div id="container2" class="svg-container">
    </div>
    <!-- <svg id="svg1" ></svg>
    <svg id="svg2" ></svg> -->
  </div>
</body>
</html>